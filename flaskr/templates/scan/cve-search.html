{% extends 'base.html' %}

{% block header %}
{% endblock %}

{% block content %}
{% if results %}
    <div class="cve-container">
        <h2>Các CVE có thể tồn tại</h2>
        {% for tech_result in results %}
            <h3>Công nghệ: {{ tech_result.tech }} - {{ tech_result.version }}</h3>
            <table class="table table-striped table-bordered small-font-table">
                <thead>
                    <tr>
                        <th>CVE</th>
                        <th>CWE</th>
                        <th>Mô tả</th>
                        <th>Vector</th>
                        <th>Base Score</th>
                        <th>Base Severity</th>
                        <th>Exploitability Score</th>
                        <th>Impact Score</th>
                        <th>Chi tiết</th>
                    </tr>
                </thead>
                <tbody>
                    {% if tech_result.results %}
                    {% for cve_detail in tech_result.results %}
                    <tr>
                        <td>{{ cve_detail[0] }}</td>
                        <td>{{ cve_detail[1] }}</td>
                        <td>{{ cve_detail[2] }}</td>
                        <td>
                            <a href="#" data-bs-toggle="modal" data-bs-target="#vectorModal" data-vector="{{ cve_detail[3] }}">
                                {{ cve_detail[3] }}
                            </a>
                        </td>
                        <td>{{ cve_detail[4] }}</td>
                        <td>{{ cve_detail[5] }}</td>
                        <td>{{ cve_detail[6] }}</td>
                        <td>{{ cve_detail[7] }}</td>
                        <td>
                            <a href="https://nvd.nist.gov/vuln/detail/{{ cve_detail[0] }}" target="_blank">
                                Xem thêm
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8">Không tìm thấy CVE nào</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        {% endfor %}
    </div>
{% else %}
    <span>Không tìm thấy kết quả</span>
{% endif %}

<!-- Modal -->
<div class="modal fade" id="vectorModal" tabindex="-1" role="dialog" aria-labelledby="vectorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vectorModalLabel">Chi tiết Vector</h5>
            </div>
            <div class="modal-body">
                <!-- Nội dung chi tiết vector sẽ được cập nhật ở đây -->
                <pre id="vectorDetails"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Thêm jQuery từ CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
    // Định nghĩa ánh xạ giải thích cho từng metric
    const cvssMapping = {
      "AV": {
        "N": { label: "Attack Vector: Network", description: "Kẻ tấn công có thể tấn công qua mạng." },
        "A": { label: "Attack Vector: Adjacent", description: "Kẻ tấn công cần truy cập từ một mạng lân cận." },
        "L": { label: "Attack Vector: Local", description: "Kẻ tấn công cần có quyền truy cập trực tiếp vào hệ thống." },
        "P": { label: "Attack Vector: Physical", description: "Kẻ tấn công cần có tiếp cận vật lý với hệ thống." }
      },
      "AC": {
        "L": { label: "Attack Complexity: Low", description: "Không yêu cầu điều kiện đặc biệt để tấn công." },
        "H": { label: "Attack Complexity: High", description: "Yêu cầu điều kiện đặc biệt để tấn công." }
      },
      "PR": {
        "N": { label: "Privileges Required: None", description: "Không cần đặc quyền để tấn công." },
        "L": { label: "Privileges Required: Low", description: "Cần đặc quyền ở mức độ thấp để tấn công." },
        "H": { label: "Privileges Required: High", description: "Cần đặc quyền ở mức độ cao để tấn công." }
      },
      "UI": {
        "N": { label: "User Interaction: None", description: "Không yêu cầu tương tác của người dùng." },
        "R": { label: "User Interaction: Required", description: "Yêu cầu tương tác của người dùng." }
      },
      "S": {
        "U": { label: "Scope: Unchanged", description: "Phạm vi không thay đổi." },
        "C": { label: "Scope: Changed", description: "Phạm vi bị thay đổi." }
      },
      "C": {
        "N": { label: "Confidentiality: None", description: "Không ảnh hưởng đến tính bảo mật." },
        "L": { label: "Confidentiality: Low", description: "Ảnh hưởng ở mức độ thấp đến tính bảo mật." },
        "H": { label: "Confidentiality: High", description: "Ảnh hưởng ở mức độ cao đến tính bảo mật." }
      },
      "I": {
        "N": { label: "Integrity: None", description: "Không ảnh hưởng đến tính toàn vẹn." },
        "L": { label: "Integrity: Low", description: "Ảnh hưởng ở mức độ thấp đến tính toàn vẹn." },
        "H": { label: "Integrity: High", description: "Ảnh hưởng ở mức độ cao đến tính toàn vẹn." }
      },
      "A": {
        "N": { label: "Availability: None", description: "Không ảnh hưởng đến khả năng truy cập." },
        "L": { label: "Availability: Low", description: "Ảnh hưởng ở mức độ thấp đến khả năng truy cập." },
        "H": { label: "Availability: High", description: "Ảnh hưởng ở mức độ cao đến khả năng truy cập." }
      }
    };
  
    // Hàm phân tích vector CVSS và trả về HTML giải thích
    function parseCvssVector(vector) {
      let parts = vector.split('/');
      let result = '';
  
      // Phần đầu tiên có thể là phiên bản (ví dụ: CVSS:3.1)
      if(parts[0].startsWith("CVSS")){
        result += `<strong>${parts[0]}</strong><br><br>`;
        parts.shift(); // loại bỏ phần phiên bản
      }
  
      parts.forEach(part => {
        // Mỗi phần có dạng "KEY:VALUE", ví dụ "AV:N"
        let [metric, value] = part.split(':');
        if (cvssMapping[metric] && cvssMapping[metric][value]) {
          result += `<strong>${cvssMapping[metric][value].label}</strong> - ${cvssMapping[metric][value].description}<br><br>`;
        } else {
          result += `<strong>${metric}:</strong> ${value}<br><br>`;
        }
      });
      return result;
    }
  
    // Xử lý sự kiện mở modal và cập nhật nội dung chi tiết vector
    document.addEventListener('DOMContentLoaded', () => {
      const vectorModal = document.getElementById('vectorModal');
      vectorModal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget; // Phần tử kích hoạt modal
        const vector = button.getAttribute('data-vector'); // Lấy vector từ thuộc tính data-vector
        const modalBody = vectorModal.querySelector('#vectorDetails');
        modalBody.innerHTML = parseCvssVector(vector);
      });
    });
</script>

{% endblock %}