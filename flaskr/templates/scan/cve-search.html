{% extends 'base.html' %}

{% block content %}
{% if results %}
    <div class="cve-container">
        <h2 class="text-center">URL: <a href=""></a>{{ url }}</h2>
        {% for tech_result in results %}
        <h3 class="text-center">Công nghệ: {{ tech_result.tech }} - {{ tech_result.version }}</h3>
        <div class="d-flex justify-content-center">
            <table 
            class="table table-striped table-bordered small-font-table" 
            style="width: 90%;"
            tech="{{ tech_result.tech }}"
            version="{{ tech_result.version }}">
                <thead>
                    <tr>
                        <th>CVE</th>
                        <th>CWE</th>
                        <th>Mô tả</th>
                        <th>Vector</th>
                        <th>Base Score</th>
                        <th>Base Severity</th>
                        <th>Chi tiết</th>
                        <th>Quét Nuclei</th>
                    </tr>
                </thead>
                <tbody>
                    {% if tech_result.results %}
                    {% for cve_detail in tech_result.results %}
                    <tr>
                        <td class="cve">{{ cve_detail[0] }}</td>
                        <td>{{ cve_detail[1] }}</td>
                        <td>{{ cve_detail[2] }}</td>
                        <td>
                            <a href="#" data-bs-toggle="modal" 
                            data-bs-target="#vectorModal" 
                            data-vector="{{ cve_detail[3] }}" 
                            data-exploitability="{{ cve_detail[6] }}" 
                            data-impact="{{ cve_detail[7] }}">
                                {{ cve_detail[3] }}
                            </a>
                        </td>
                        <td>{{ cve_detail[4] }}</td>
                        <td>{{ cve_detail[5] }}</td>
                        <td>
                            <a href="https://nvd.nist.gov/vuln/detail/{{ cve_detail[0] }}" target="_blank">
                                Xem thêm
                            </a>
                        </td>
                        <td>
                            <div id="nuclei-result-{{ cve_detail[0] }}">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8">Không tìm thấy CVE nào</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
{% else %}
    <span>Không tìm thấy kết quả</span>
{% endif %}
<div class="d-flex justify-content-center pb-3">
    <button type="button" class="btn btn-primary" id="watchlistButton">
        Lưu vào danh sách theo dõi
    </button>
</div>

<!-- Modal -->
<div class="modal fade" id="vectorModal" tabindex="-1" role="dialog" aria-labelledby="vectorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vectorModalLabel">Chi tiết Vector</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Nội dung chi tiết vector sẽ được cập nhật ở đây -->
                <pre id="vectorDetails"></pre>
                <p><strong>Exploitability Score:</strong> <span id="exploitabilityScore"></span></p>
                <p><strong>Impact Score:</strong> <span id="impactScore"></span></p>
                <div id="cvssDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const url = "{{ url }}";

    const cvssMapping = {
        "AV": {
            "N": { label: "Attack Vector: Network", description: "Kẻ tấn công có thể tấn công qua mạng." },
            "A": { label: "Attack Vector: Adjacent", description: "Kẻ tấn công cần truy cập từ một mạng lân cận." },
            "L": { label: "Attack Vector: Local", description: "Kẻ tấn công cần có quyền truy cập trực tiếp vào hệ thống." },
            "P": { label: "Attack Vector: Physical", description: "Kẻ tấn công cần có tiếp cận vật lý với hệ thống." }
        },
        "AC": {
            "L": { label: "Attack Complexity: Low", description: "Không yêu cầu điều kiện đặc biệt để tấn công." },
            "H": { label: "Attack Complexity: High", description: "Yêu cầu điều kiện đặc biệt để tấn công." }
        },
        "PR": {
            "N": { label: "Privileges Required: None", description: "Không cần đặc quyền để tấn công." },
            "L": { label: "Privileges Required: Low", description: "Cần đặc quyền ở mức độ thấp để tấn công." },
            "H": { label: "Privileges Required: High", description: "Cần đặc quyền ở mức độ cao để tấn công." }
        },
        "UI": {
            "N": { label: "User Interaction: None", description: "Không yêu cầu tương tác của người dùng." },
            "R": { label: "User Interaction: Required", description: "Yêu cầu tương tác của người dùng." }
        },
        "S": {
            "U": { label: "Scope: Unchanged", description: "Phạm vi không thay đổi." },
            "C": { label: "Scope: Changed", description: "Phạm vi bị thay đổi." }
        },
        "C": {
            "N": { label: "Confidentiality: None", description: "Không ảnh hưởng đến tính bảo mật." },
            "L": { label: "Confidentiality: Low", description: "Ảnh hưởng ở mức độ thấp đến tính bảo mật." },
            "H": { label: "Confidentiality: High", description: "Ảnh hưởng ở mức độ cao đến tính bảo mật." }
        },
        "I": {
            "N": { label: "Integrity: None", description: "Không ảnh hưởng đến tính toàn vẹn." },
            "L": { label: "Integrity: Low", description: "Ảnh hưởng ở mức độ thấp đến tính toàn vẹn." },
            "H": { label: "Integrity: High", description: "Ảnh hưởng ở mức độ cao đến tính toàn vẹn." }
        },
        "A": {
            "N": { label: "Availability: None", description: "Không ảnh hưởng đến khả năng truy cập." },
            "L": { label: "Availability: Low", description: "Ảnh hưởng ở mức độ thấp đến khả năng truy cập." },
            "H": { label: "Availability: High", description: "Ảnh hưởng ở mức độ cao đến khả năng truy cập." }
        }
    };

    // Quét từng CVE bằng Nuclei
    document.addEventListener('DOMContentLoaded', () => {
        const cveElements = document.querySelectorAll('.cve');
        const cves = Array.from(cveElements).map(el => el.innerText.trim());

        fetch('/nuclei_scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url, cves })
        })
        .then(response => response.json())
        .then(data => {
          console.log(data)
            cves.forEach(cve => {
                const resultElement = document.getElementById(`nuclei-result-${cve}`);
                if (data[cve]) {
                    resultElement.innerHTML = data[cve].status;
                } else {
                    resultElement.innerHTML = "Không tìm thấy template";
                }
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    // Tạo modal box để hiển thị chi tiết CPE và score
    $('#vectorModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // Nút đã kích hoạt modal
        var vector = button.data('vector'); // Lấy giá trị vector từ thuộc tính data-vector
        var exploitability = button.data('exploitability'); // Lấy giá trị exploitability từ thuộc tính data-exploitability
        var impact = button.data('impact'); // Lấy giá trị impact từ thuộc tính data-impact
        var modal = $(this);
        modal.find('.modal-body #vectorDetails').text(vector); // Cập nhật nội dung của modal
        modal.find('.modal-body #exploitabilityScore').text(exploitability); // Cập nhật exploitability score
        modal.find('.modal-body #impactScore').text(impact); // Cập nhật impact score

        // Cập nhật chi tiết CVSS
        var cvssDetails = '';
        vector.split('/').forEach(part => {
            const [metric, value] = part.split(':');
            if (cvssMapping[metric] && cvssMapping[metric][value]) {
                cvssDetails += `<p><strong>${cvssMapping[metric][value].label}:</strong> ${cvssMapping[metric][value].description}</p>`;
            }
        });
        modal.find('.modal-body #cvssDetails').html(cvssDetails);
    });
    
    // Lưu data vào cơ sở dữ liệu
    document.getElementById('watchlistButton').addEventListener('click', function() {
        const button = this;
        if (button.classList.contains('btn-primary')) {
            fetch('/add_to_watchlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gatherData())
            })
            .then(response => response.text())
            .then(text => {
                alert(text);
            })
            .catch(error => {
                console.log(error);
            });
            button.classList.remove('btn-primary');
            button.classList.add('btn-danger');
            button.textContent = 'Bỏ khỏi danh sách theo dõi';
        } else {
            fetch('/remove_from_watchlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/html; charset=utf-8'
                },
                body: url
            })
            .then(response => response.text())
            .then(text => {
                alert(text);
            })
            .catch(error => {
                console.log(error);
            });
            button.classList.remove('btn-danger');
            button.classList.add('btn-primary');
            button.textContent = 'Lưu vào danh sách theo dõi';
        }
    });

    // Thu thập thêm và chuẩn hóa lại data
    function gatherData() {
        let mergeData = []
        const tables = document.querySelectorAll('table');
        tables.forEach(table => {
            let singleResult = {}
            singleResult  = {
                tech: table.getAttribute('tech'),
                version: table.getAttribute('version'),
                cves: []
            }
            table.querySelectorAll('tr').forEach(row => {
                const cveCell = row.querySelector('.cve');
                if (cveCell) {
                    const cells = row.querySelectorAll('td');
                    const cve = cveCell.textContent.trim();
                    const cwe = cells[1] ? cells[1].textContent.trim() : "";
                    const description = cells[2] ? cells[2].textContent.trim() : "";
                    const vectorString = cells[3] ? cells[3].textContent.trim() : "";
                    const baseScore = cells[4] ? parseFloat(cells[4].textContent.trim()) : 0.0;
                    const baseSeverity = cells[5] ? cells[5].textContent.trim() : "";
                    
                    // Lấy exploitabilityScore và impactScore
                    const exploitabilityScore = cells[3] ? parseFloat(cells[3].querySelector('a').getAttribute('data-exploitability').trim()) : 0.0;
                    const impactScore = cells[3] ? parseFloat(cells[3].querySelector('a').getAttribute('data-impact').trim()) : 0.0;
                    const nucleiElement = row.querySelector(`#nuclei-result-${cve}`);
                    const nucleiResult = nucleiElement ? nucleiElement.innerText.trim() : ""; 
                    
                    // Đẩy vào cves
                    singleResult.cves.push({
                        cve: cve,
                        cwe: cwe,
                        description: description,
                        vectorString: vectorString,
                        baseScore: baseScore,
                        baseSeverity: baseSeverity,
                        exploitabilityScore: exploitabilityScore,
                        impactScore: impactScore,
                        nucleiResult: nucleiResult
                    })
                }
            })
            mergeData.push(singleResult);
        })
        const finalData = {
            url: url,
            results: mergeData
        }
        return finalData
    }
</script>

{% endblock %}