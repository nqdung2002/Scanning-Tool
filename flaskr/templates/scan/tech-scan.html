{% extends 'base.html' %}

{% block header %}
<h1>{% block title %}Scanning{% endblock %}</h1>
{% endblock %}

{% block content %}
<!-- Form nhập URL để quét -->
<form id="scan-form">
    <label for="url">URL</label>
    <input id="url" name="url" required>
    <input id="start-button" type="submit" value="Scan">
</form>

<!-- Hiển thị trạng thái đang quét -->
<div class="loading" id="loading" style="display: none;">
    <div id="loading-spinner"></div>
    <p>Đang quét, vui lòng đợi...</p>
</div>

<!-- Vùng hiển thị kết quả -->
<div id="scan-results"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
<script>
    checkStatusInterval = null; // Biến lưu interval để kiểm tra trạng thái
    var socket = io(); // Khởi tạo socket.io

    // Lắng nghe sự kiện 'status_update'
    socket.on('status_update', function(data) {
        console.log('Cập nhật status nhận được:', data);
        document.getElementById('url-status').innerText = data.url_status;
    });

    // Lắng nghe sự kiện 'error'
    socket.on('error', function(data) {
        console.error('Lỗi nhận được:', data.message);
        alert(data.message);  // Hiển thị thông báo lỗi
    });

    // Xử lý form submit
    document.getElementById("scan-form").addEventListener("submit", function(event) {
        event.preventDefault(); // Ngăn form reload trang

        let urlInput = document.getElementById("url").value;
        let loadingScreen = document.getElementById("loading");
        let resultsContainer = document.getElementById("scan-results");

        if (!urlInput) {
            alert("Vui lòng nhập URL hợp lệ!");
            return;
        }

        loadingScreen.style.display = "flex"; // Hiện loading

        fetch("/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-Requested-With": "XMLHttpRequest"  // Để Flask nhận biết đây là AJAX
            },
            body: new URLSearchParams({ "url": urlInput })
        })
        .then(response => response.text())  // Nhận HTML từ Flask
        .then(html => {
            loadingScreen.style.display = "none";
            resultsContainer.innerHTML = html; // Hiển thị kết quả quét
        })
        .catch(error => {
            console.error("Lỗi:", error);
            loadingScreen.style.display = "none";
        });
    });
    
    // Hàm xử lý khi input thay đổi
    function toggleCheckbox(input) {
        let checkbox = input.closest("tr")?.querySelector(".tech-check");
        if (checkbox) {
            if (input.value.trim() !== "" && input.value.trim() !== "N/A") {
                checkbox.disabled = false;  
                checkbox.checked = true;    
            } else {
                checkbox.disabled = true;  
                checkbox.checked = false;   
            }
        }
    }

    // Hàm lấy trạng thái từ server
    function fetchStatus() {
        fetch('/status')
            .then(response => response.json())
            .then(data => {
                console.log("Status data:", data.url_status); // Log giá trị của data.url_status
                document.getElementById('url-status').innerText = data.url_status;
            })
            .catch(error => console.error('Error:', error));
    }

    // Hàm dừng kiểm tra trạng thái
    function stopCheckingStatus() {
        fetch('/stop-status', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                document.getElementById('url-status').innerText = "Đã dừng kiểm tra trạng thái";
                if (data.success) {
                    if (checkStatusInterval !== null) {
                        clearInterval(checkStatusInterval);
                        checkStatusInterval = null;
                    }
                    alert('Stopped checking status.');
                } else {
                    alert('Failed to stop checking status.');
                }
            })
        .catch(error => console.error('Error:', error));
    }

    // Khi trang load, kiểm tra tất cả các input
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll("input[name='version']").forEach(toggleCheckbox);
    });

    // Dùng MutationObserver để tự động kiểm tra khi nội dung #scan-results thay đổi
    const observer = new MutationObserver(() => {
        document.querySelectorAll("input[name='version']").forEach(toggleCheckbox);
    });
    observer.observe(document.getElementById("scan-results"), { childList: true, subtree: true });
</script>

{% endblock %}