{% extends 'base.html' %}

{% block header %}
{% endblock %}

{% block content %}
<div class="container d-flex flex-column justify-content-center align-items-center">
    <!-- Form nhập URL để quét -->
    <form id="scan-form" class="form-inline p-1">
        <label for="url">URL</label>
        <input id="url" name="url" required>
        <input id="start-button" type="submit" value="Scan">
    </form>

    <!-- Hiển thị trạng thái đang quét -->
    <div id="loading" style="display: none;" class="p-1">
        <div class="spinner-grow" role="status"></div>
        <span>Đang quét...</span>
    </div>

    <!-- Vùng hiển thị kết quả -->
    <div id="scan-results" class="p-1"></div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
<script>
    var socket = io(); // Khởi tạo socket.io

    // Lắng nghe sự kiện 'status_update'
    socket.on('status_update', function(data) {
        console.log('Cập nhật status nhận được:', data);
        document.getElementById('url-status').innerText = data.url_status;
        document.getElementById('last-success-time').innerText = data.last_success_time;
    });

    // Lắng nghe sự kiện 'error'
    socket.on('error', function(data) {
        console.error('Lỗi nhận được:', data.message);
        alert(data.message);  // Hiển thị thông báo lỗi
    });

    // Xử lý form submit
    document.getElementById("scan-form").addEventListener("submit", function(event) {
        event.preventDefault(); // Ngăn form reload trang

        let urlInput = document.getElementById("url").value;
        let loadingScreen = document.getElementById("loading");
        let resultsContainer = document.getElementById("scan-results");

        if (!urlInput) {
            alert("Vui lòng nhập URL hợp lệ!");
            return;
        }

        loadingScreen.style.display = "flex"; // Hiện loading

        fetch("/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-Requested-With": "XMLHttpRequest"  // Để Flask nhận biết đây là AJAX
            },
            body: new URLSearchParams({ "url": urlInput })
        })
        .then(response => response.text())  // Nhận HTML từ Flask
        .then(html => {
            loadingScreen.style.display = "none";
            resultsContainer.innerHTML = html; // Hiển thị kết quả quét
        })
        .catch(error => {
            console.error("Lỗi:", error);
            loadingScreen.style.display = "none";
        });
    });

    // Hàm xử lý khi submit vuln scan
    function submitVulnScanForm() {
        let tableContainer = document.getElementById("table-content");
        let resultsContainer = document.getElementById("vuln-scan-result");

        fetch("/vuln", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Requested-With": "XMLHttpRequest"  // Để Flask nhận biết đây là AJAX
            },
            body: JSON.stringify(Array.from(document.querySelectorAll(".tech-check:checked")).map(checkbox => {
                let row = checkbox.closest("tr");
                let tech = row.querySelector("[name='tech']").innerText;
                let version = row.querySelector("[name='version']").value;
                return { tech, version };
            }))
        })
        .then(response => response.text())
        .then(html => {
            tableContainer.style.display = "none"; // Ẩn bảng công nghệ
            resultsContainer.style.display = "block"; // Hiển thị kết quả kiểm tra lỗ hổng
            resultsContainer.innerHTML = html; // Hiển thị kết quả kiểm tra lỗ hổng
        })
        .catch(error => console.error("Lỗi:", error));
    }

    
    // Hàm xử lý khi input thay đổi
    function toggleCheckbox(input) {
        let checkbox = input.closest("tr")?.querySelector(".tech-check");
        if (checkbox) {
            if (input.value.trim() !== "" && input.value.trim() !== "N/A") {
                checkbox.disabled = false;  
            } else {
                checkbox.disabled = true;  
            }
        }
    }

    // Hàm dừng kiểm tra trạng thái
    function stopCheckingStatus() {
        fetch('/stop-status', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                document.getElementById('url-status').innerText = "Đã dừng kiểm tra trạng thái";
            })
        .catch(error => console.error('Error:', error));
    }

    // Hàm chọn tất cả checkbox
    function selectAllCheckbox() {
        let checkboxes = document.querySelectorAll(".tech-check:enabled");
        let selectAll = document.getElementById("select-all");

        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    }

    // Khi trang load, kiểm tra tất cả các input
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll("input[name='version']").forEach(toggleCheckbox);
    });

    // Dùng MutationObserver để tự động kiểm tra khi nội dung #scan-results thay đổi
    const observer = new MutationObserver(() => {
        document.querySelectorAll("input[name='version']").forEach(toggleCheckbox);
    });
    observer.observe(document.getElementById("scan-results"), { childList: true, subtree: true });
</script>

{% endblock %}